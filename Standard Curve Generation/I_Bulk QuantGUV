import cv2
import numpy as np
import os
from openpyxl import Workbook

# Folder paths
input_folder = r"C:\Users\zm00198\OneDrive - University of Surrey\Desktop\6482526 PhD - NANOPC\Results\GUV Microscopy\PEG with GFP\gain 1 mEGFP 0 to 5"
output_folder = r"C:\Users\zm00198\OneDrive - University of Surrey\Desktop\6482526 PhD - NANOPC\Results\GUV Microscopy\PEG with GFP\gain 1 mEGFP 0 to 5"
# Define the Excel file path
excel_path = os.path.join(output_folder, "FS.xlsx")

# Create a new Excel workbook and sheet
workbook = Workbook()
sheet = workbook.active
sheet.title = "Intensity Data"

# Add headers to the first row
headers = ["Image Name", "Average Pixel Intensity"]
for col, header in enumerate(headers, start=1):
    sheet.cell(row=1, column=col, value=header)

# Row counter for Excel
excel_row = 2

# Ensure output folder exists
os.makedirs(output_folder, exist_ok=True)

# Process each image in the input folder
for filename in os.listdir(input_folder):
    if filename.lower().endswith(".tif"):
        image_path = os.path.join(input_folder, filename)
        
        # Step 1: Read image in grayscale (RAW TIF image, unchanged)
        image = cv2.imread(image_path, cv2.IMREAD_UNCHANGED)
        if image is None:
            print(f"Error: Unable to load image {filename}")
            continue

        # Determine center coordinates
        height, width = image.shape
        center_x, center_y = width // 2, height // 2
        square_size = 100  # Define the size of the square
        half_size = square_size // 2
        
        # Define the region of interest (ROI)
        top_left_x = max(center_x - half_size, 0)
        top_left_y = max(center_y - half_size, 0)
        bottom_right_x = min(center_x + half_size, width)
        bottom_right_y = min(center_y + half_size, height)
        
        # Extract square region for intensity calculation
        square_region = image[top_left_y:bottom_right_y, top_left_x:bottom_right_x]
        avg_intensity = np.mean(square_region)  # Calculate average intensity

        # Write data to Excel
        sheet.cell(row=excel_row, column=1, value=filename)  # Image name
        sheet.cell(row=excel_row, column=2, value=round(avg_intensity, 2))  # Average intensity
        excel_row += 1
        
        print(f"Processed: {filename}, Avg Intensity: {avg_intensity:.2f}")

# Save the Excel workbook
workbook.save(excel_path)
print(f"Excel file saved as: {excel_path}")
print("Processing complete.")
